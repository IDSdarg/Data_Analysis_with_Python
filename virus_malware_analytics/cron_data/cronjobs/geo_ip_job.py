import os
import requests
import pandas as pd


geo_file_url = os.path.join(os.getcwd(), 'input')
out_geo_file_url = os.path.join(os.getcwd(), 'output')

ip_lookup = []
start_day = pd.datetime.today().day
start_hr = pd.datetime.today().hour


def lookup_ip_geodata(list_of_ips):
    """ Comment"""
    for ip in list_of_ips:
        r = requests.get("http://freegeoip.net/json/"+ip)
        if r.ok:
            ip_lookup.append(r.json())
    return ip_lookup


def get_more_ipdata():
    """ Some comments """

    # Check if file exist and read it. Else print msg to log and exit function
    file_url = os.path.join(geo_file_url, "geoip_{0}_{1}.csv".format(start_day, start_hr))
    print(file_url)

    if not os.path.isfile(file_url):
        return "File does not exist!"
    else:
        # Call 'lookup_ip_geodata' to fetch API data and populate global variable `ip_lookup`
        in_file = pd.read_csv(file_url, index_col=0)
        lookup_ip_geodata(in_file.IP_Address[:5])

    # Convert global variable `ip_lookup` to dataframe and save in .csv file.
    ip_geodata_lookup = pd.DataFrame(ip_lookup)
    path = os.path.join(out_geo_file_url, "out_geodata_{}_{}.csv".format(start_day, start_hr))
    ip_geodata_lookup.to_csv(path)

    return


# Execute the script
if __name__ == '__main__':
    get_more_ipdata()
